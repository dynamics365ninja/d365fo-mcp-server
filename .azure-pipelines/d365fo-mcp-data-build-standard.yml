# Azure Pipeline for Standard D365FO Metadata Extraction from Azure Blob Storage
# This pipeline downloads and extracts standard D365 models from PackagesLocalDirectory.zip
# Runs: Few times per year (D365 upgrade, hotfix) or manual trigger

trigger: none  # Manual execution only

pool:
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: mcpServer
      type: github
      endpoint: github.com_dynamics365ninja
      name: dynamics365ninja/d365fo-mcp-server
      ref: refs/heads/main

variables:
  - group: xpp-mcp-server-config
  - name: nodeVersion
    value: '22.x'
  - name: METADATA_PATH
    value: './metadata'
  - name: DB_PATH
    value: './database/xpp-metadata.db'
  - name: PACKAGES_DIR_NAME
    value: 'PackagesLocalDirectory'
  - name: PACKAGES_ZIP_PATH
    value: '$(Pipeline.Workspace)/$(PACKAGES_DIR_NAME).zip'
  - name: PACKAGES_CONTAINER_NAME
    value: 'packages'
  - name: MCP_SERVER_PATH
    value: '$(Pipeline.Workspace)/mcp-server'

stages:
  # ============================================================================
  # Single Stage: Download, Extract, and Upload
  # ============================================================================
  - stage: ExtractAndUpload
    displayName: 'Extract Standard Metadata and Upload to Blob'
    jobs:
      - job: ProcessJob
        displayName: 'Download → Extract → Upload'
        steps:
          # ========== Checkout MCP Server code from GitHub ==========
          - checkout: mcpServer
            displayName: 'Checkout MCP Server code from GitHub'
            path: mcp-server

          # ========== Step 1: Install Node.js and Dependencies ==========
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: 'Install NPM dependencies'
            workingDirectory: '$(MCP_SERVER_PATH)'

          # ========== Step 2: Download PackagesLocalDirectory.zip from Azure Blob ==========
          
          - script: |
              echo "Downloading $(PACKAGES_DIR_NAME).zip from Azure Blob Storage..."
              az storage blob download \
                --connection-string "$AZURE_STORAGE_CONNECTION_STRING" \
                --container-name $(PACKAGES_CONTAINER_NAME) \
                --name $(PACKAGES_DIR_NAME).zip \
                --file $(PACKAGES_ZIP_PATH) \
                --output table
              
              echo "Download completed successfully"
              ls -lh $(PACKAGES_ZIP_PATH)
            displayName: 'Download $(PACKAGES_DIR_NAME).zip from Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)

          # ========== Step 3: Extract PackagesLocalDirectory.zip ==========
          
          - script: |
              echo "Extracting $(PACKAGES_DIR_NAME).zip..."
              unzip -q $(PACKAGES_ZIP_PATH) -d $(Pipeline.Workspace)
              
              echo "Extraction completed successfully"
              echo "Contents of extracted directory:"
              ls -la $(Pipeline.Workspace)/$(PACKAGES_DIR_NAME)
            displayName: 'Extract $(PACKAGES_DIR_NAME).zip'

          # ========== Step 4: Extract Metadata ==========
          
          - script: npm run extract-metadata
            displayName: 'Extract standard metadata from packages'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              PACKAGES_PATH: $(Pipeline.Workspace)/$(PACKAGES_DIR_NAME)
              METADATA_PATH: $(METADATA_PATH)
              EXTRACT_MODE: 'standard'

          # ========== Step 5: Upload Metadata to Blob Storage ==========
          
          - script: npm run blob-manager upload-standard
            displayName: 'Upload standard metadata to Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)

          # ========== Step 6: Build Database ==========
          
          - script: npm run build-database
            displayName: 'Build database from standard metadata'
            workingDirectory: '$(MCP_SERVER_PATH)'
            timeoutInMinutes: 120  # Increase timeout to 2 hours for 350+ models
            env:
              METADATA_PATH: $(METADATA_PATH)
              DB_PATH: $(DB_PATH)
              ENABLE_SEARCH_SUGGESTIONS: 'false'  # Disable suggestions in CI/CD to reduce memory usage
              NODE_OPTIONS: '--max-old-space-size=4096 --expose-gc'  # Increase heap to 8GB for single-transaction indexing

          # ========== Step 7: Upload Database to Blob Storage ==========
          
          - script: npm run blob-manager upload-database
            displayName: 'Upload compiled database to Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              DB_PATH: $(DB_PATH)

          # Restart App Service
          - task: AzureAppServiceManage@0
            displayName: 'Restart App Service'
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              action: 'Restart Azure App Service'
              webAppName: '$(AZURE_APP_SERVICE_NAME)'

          # ========== Step 8: Log Completion ==========
          
          - script: |
              echo ""
              echo "============================================"
              echo "Standard metadata extraction completed!"
              echo "============================================"
              echo ""
              echo "✅ $(PACKAGES_DIR_NAME).zip downloaded from Azure Blob"
              echo "✅ Package extracted"
              echo "✅ Metadata extracted"
              echo "✅ Metadata uploaded to: metadata/standard/"
              echo "✅ Database built"
              echo "✅ Database uploaded to Azure Blob"
              echo ""
              echo "Next step: Run custom pipeline to update custom models"
              echo "============================================"
            displayName: 'Log completion summary'