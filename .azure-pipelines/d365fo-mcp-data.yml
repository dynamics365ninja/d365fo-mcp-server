# Azure DevOps Pipeline for X++ Metadata Extraction and Database Build
# This pipeline automates metadata extraction with separation of standard and custom models
# Trigger: On changes to specific paths or manual execution

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'src/**'
      - 'scripts/**'
      - 'd365fo-mcp-data.yml'

# Manual trigger for on-demand extraction
pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: xpp-mcp-server-config  # Variable group with Azure credentials
  - name: nodeVersion
    value: '22.x'
  - name: METADATA_PATH
    value: './extracted-metadata'
  - name: DB_PATH
    value: './data/xpp-metadata.db'

stages:
  # ============================================================================
  # Single Stage: Extract, Build, Upload, and Restart - All Sequential
  # ============================================================================
  - stage: ProcessAll
    displayName: 'Process Custom Metadata'
    jobs:
      - job: ProcessJob
        displayName: 'Download → Extract → Build → Upload → Restart'
        steps:
          - checkout: self
            displayName: 'Checkout D365FO source code'
            path: 'd365fo-source'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: 'Install dependencies'

          # ========== Step 1: Download Standard Metadata ==========
          
          - script: npm run blob-manager download-standard
            displayName: 'Download standard metadata from Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)

          # ========== Step 2: Extract Custom Models ==========
          
          # Delete old custom metadata (local)
          - script: npm run blob-manager delete-local-custom
            displayName: 'Delete old local custom metadata'
            env:
              METADATA_PATH: $(METADATA_PATH)
              CUSTOM_MODELS: $(CUSTOM_MODELS)
              EXTENSION_PREFIX: $(EXTENSION_PREFIX)

          # Extract only custom models from Git repository
          - script: npm run extract-metadata
            displayName: 'Extract custom metadata from source code'
            env:
              PACKAGES_PATH: $(Pipeline.Workspace)/d365fo-source
              METADATA_PATH: $(METADATA_PATH)
              EXTRACT_MODE: 'custom'
              CUSTOM_MODELS: $(CUSTOM_MODELS)
              EXTENSION_PREFIX: $(EXTENSION_PREFIX)

          # ========== Step 3: Build Database ==========
          
          - script: npm run build-database
            displayName: 'Build SQLite database with FTS5 indexes'
            env:
              METADATA_PATH: $(METADATA_PATH)
              DB_PATH: $(DB_PATH)

          # ========== Step 4: Upload to Azure Blob Storage ==========
          
          # Delete old custom metadata from blob
          - script: npm run blob-manager delete-custom
            displayName: 'Delete old custom metadata from Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              CUSTOM_MODELS: $(CUSTOM_MODELS)

          # Upload only custom metadata to blob
          - script: npm run blob-manager upload-custom
            displayName: 'Upload new custom metadata to Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)
              CUSTOM_MODELS: $(CUSTOM_MODELS)
              EXTENSION_PREFIX: $(EXTENSION_PREFIX)

          # Upload compiled database
          - script: npm run blob-manager upload-database $(DB_PATH)
            displayName: 'Upload compiled database to Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              DB_PATH: $(DB_PATH)

          # ========== Step 5: Restart App Service ==========
          
          - task: AzureAppServiceManage@0
            displayName: 'Restart Azure App Service to load new database'
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              action: 'Restart Azure App Service'
              webAppName: '$(AZURE_APP_SERVICE_NAME)'
