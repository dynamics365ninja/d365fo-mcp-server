# Azure Pipeline for D365 Platform Upgrade
# This pipeline combines standard and custom metadata extraction in single stage
# Use this after Microsoft releases new D365 version
# Pipeline automatically downloads latest version from NuGet (10.0.* and 7.0.*)

trigger: none  # Manual execution only

pool:
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: mcpServer
      type: github
      endpoint: github.com_dynamics365ninja
      name: dynamics365ninja/d365fo-mcp-server
      ref: refs/heads/main

variables:
  - group: xpp-mcp-server-config
  - name: nodeVersion
    value: '22.x'
  - name: METADATA_PATH
    value: './metadata'
  - name: DB_PATH
    value: './database/xpp-metadata.db'
  - name: PACKAGES_DIR_NAME
    value: 'PackagesLocalDirectory'
  - name: PACKAGES_ZIP_PATH
    value: '$(Pipeline.Workspace)/$(PACKAGES_DIR_NAME).zip'
  - name: PACKAGES_CONTAINER_NAME
    value: 'packages'
  - name: MCP_SERVER_PATH
    value: '$(Pipeline.Workspace)/mcp-server'

stages:
  # ============================================================================
  # Single Stage: Complete Platform Upgrade
  # ============================================================================
  - stage: PlatformUpgrade
    displayName: 'Complete Platform Upgrade'
    jobs:
      - job: UpgradeJob
        displayName: 'Download → Extract Standard → Extract Custom → Build → Upload'
        steps:
          # ========== Step 1: Checkout MCP Server code from GitHub ==========
          - checkout: mcpServer
            displayName: 'Checkout MCP Server code from GitHub'
            path: mcp-server
        
          # ========== Step 2: Install Node.js and Dependencies ==========
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: 'Install NPM dependencies'
            workingDirectory: '$(MCP_SERVER_PATH)'

          # ========== Step 3: Download PackagesLocalDirectory.zip from Azure Blob ==========
          
          - script: |
              echo "Downloading $(PACKAGES_DIR_NAME).zip from Azure Blob Storage..."
              az storage blob download \
                --connection-string "$AZURE_STORAGE_CONNECTION_STRING" \
                --container-name $(PACKAGES_CONTAINER_NAME) \
                --name $(PACKAGES_DIR_NAME).zip \
                --file $(PACKAGES_ZIP_PATH) \
                --output table
              
              echo "Download completed successfully"
              ls -lh $(PACKAGES_ZIP_PATH)
            displayName: 'Download $(PACKAGES_DIR_NAME).zip from Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)

          # ========== Step 4: Extract PackagesLocalDirectory.zip ==========
          
          - script: |
              echo "Extracting $(PACKAGES_DIR_NAME).zip..."
              unzip -q $(PACKAGES_ZIP_PATH) -d $(Pipeline.Workspace)
              
              echo "Extraction completed successfully"
              echo "Contents of extracted directory:"
              ls -la $(Pipeline.Workspace)/$(PACKAGES_DIR_NAME)
            displayName: 'Extract $(PACKAGES_DIR_NAME).zip'

          # ========== Step 5: Extract Standard Metadata ==========
          
          - script: npm run extract-metadata
            displayName: 'Extract standard metadata from packages'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              PACKAGES_PATH: $(Pipeline.Workspace)/$(PACKAGES_DIR_NAME)
              METADATA_PATH: $(METADATA_PATH)
              EXTRACT_MODE: 'standard'

          # ========== Step 6: Upload Standard Metadata to Blob Storage ==========
          
          - script: npm run blob-manager upload-standard
            displayName: 'Upload standard metadata to Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)

          # ========== Step 7: Download Custom Metadata from Azure Blob ==========
          
          - script: npm run blob-manager download-custom
            displayName: 'Download custom metadata from Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)

          # ========== Step 8: Build Database ==========
          
          - script: npm run build-database
            displayName: 'Build database (standard + custom)'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              METADATA_PATH: $(METADATA_PATH)
              DB_PATH: $(DB_PATH)
              ENABLE_SEARCH_SUGGESTIONS: 'false'  # Disable suggestions in CI/CD to reduce memory usage
              NODE_OPTIONS: '--max-old-space-size=2048'  # Increase heap size to 2GB for large metadata sets

          # ========== Step 9: Upload Database to Blob Storage ==========

          - script: npm run blob-manager upload-database
            displayName: 'Upload compiled database to Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              DB_PATH: $(DB_PATH)

          # ========== Step 10: Restart App Service ==========

          - task: AzureAppServiceManage@0
            displayName: 'Restart App Service'
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              action: 'Restart Azure App Service'
              webAppName: '$(AZURE_APP_SERVICE_NAME)'

          # ========== Step 11: Log Completion ==========
          
          - script: |
              echo ""
              echo "============================================"
              echo "D365 Platform Upgrade Completed!"
              echo "============================================"
              echo ""
              echo "✅ $(PACKAGES_DIR_NAME).zip downloaded from Azure Blob"
              echo "✅ Package extracted"
              echo "✅ Standard metadata extracted and uploaded"
              echo "✅ Custom metadata downloaded from Blob"
              echo "✅ Database built and uploaded"
              echo "✅ App Service restarted"
              echo ""
              echo "Your MCP server is now running with the latest D365 version"
              echo "============================================"
            displayName: 'Log completion summary'
