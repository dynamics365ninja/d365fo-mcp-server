# Azure Pipeline for Standard D365FO Metadata Extraction from Azure Blob Storage
# This pipeline downloads and extracts standard D365 models from PackagesLocalDirectory.zip
# Runs: Few times per year (D365 upgrade, hotfix) or manual trigger

trigger: none  # Manual execution only

# Schedule: Run on first day of each quarter (or as needed)
schedules:
  - cron: "0 3 1 1,4,7,10 *"  # 3 AM UTC on Jan 1, Apr 1, Jul 1, Oct 1
    displayName: Quarterly standard metadata extraction
    branches:
      include:
        - main
    always: false  # Only run if there are changes

pool:
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: mcpServer
      type: github
      endpoint: github.com_dynamics365ninja
      name: dynamics365ninja/d365fo-mcp-server
      ref: refs/heads/main

variables:
  - group: xpp-mcp-server-config
  - name: nodeVersion
    value: '22.x'
  - name: METADATA_PATH
    value: './metadata'
  - name: DB_PATH
    value: './database/xpp-metadata.db'
  - name: PACKAGES_ZIP_PATH
    value: '$(Pipeline.Workspace)/PackagesLocalDirectory.zip'
  - name: PACKAGES_PATH
    value: '$(Pipeline.Workspace)/PackagesLocalDirectory'
  - name: PACKAGES_CONTAINER_NAME
    value: 'packages'
  - name: MCP_SERVER_PATH
    value: '$(Pipeline.Workspace)/mcp-server'

stages:
  # ============================================================================
  # Single Stage: Download, Extract, and Upload
  # ============================================================================
  - stage: ExtractAndUpload
    displayName: 'Extract Standard Metadata and Upload to Blob'
    jobs:
      - job: ProcessJob
        displayName: 'Download → Extract → Upload'
        steps:
          # ========== Checkout MCP Server code from GitHub ==========
          - checkout: mcpServer
            displayName: 'Checkout MCP Server code from GitHub'
            path: mcp-server

          # ========== Step 1: Install Node.js and Dependencies ==========
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: 'Install NPM dependencies'
            workingDirectory: '$(MCP_SERVER_PATH)'

          # ========== Step 2: Download PackagesLocalDirectory.zip from Azure Blob ==========
          
          - script: |
              echo "Downloading PackagesLocalDirectory.zip from Azure Blob Storage..."
              az storage blob download \
                --connection-string "$AZURE_STORAGE_CONNECTION_STRING" \
                --container-name $(PACKAGES_CONTAINER_NAME) \
                --name PackagesLocalDirectory.zip \
                --file $(PACKAGES_ZIP_PATH) \
                --output table
              
              echo "Download completed successfully"
              ls -lh $(PACKAGES_ZIP_PATH)
            displayName: 'Download PackagesLocalDirectory.zip from Azure Blob'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)

          # ========== Step 3: Extract PackagesLocalDirectory.zip ==========
          
          - script: |
              echo "Extracting PackagesLocalDirectory.zip..."
              mkdir -p $(PACKAGES_PATH)
              unzip -q $(PACKAGES_ZIP_PATH) -d $(PACKAGES_PATH)
              
              echo "Extraction completed successfully"
              echo "Contents of extracted directory:"
              ls -la $(PACKAGES_PATH)
            displayName: 'Extract PackagesLocalDirectory.zip'

          # ========== Step 4: Extract Metadata ==========
          
          - script: npm run extract-metadata
            displayName: 'Extract standard metadata from packages'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              PACKAGES_PATH: $(PACKAGES_PATH)
              METADATA_PATH: $(METADATA_PATH)
              EXTRACT_MODE: 'standard'

          # ========== Step 5: Upload to Blob Storage ==========
          
          - script: npm run blob-manager upload-standard
            displayName: 'Upload standard metadata to Azure Blob'
            workingDirectory: '$(MCP_SERVER_PATH)'
            env:
              AZURE_STORAGE_CONNECTION_STRING: $(AZURE_STORAGE_CONNECTION_STRING)
              BLOB_CONTAINER_NAME: $(BLOB_CONTAINER_NAME)
              METADATA_PATH: $(METADATA_PATH)

          # ========== Step 6: Log Completion ==========
          
          - script: |
              echo ""
              echo "============================================"
              echo "Standard metadata extraction completed!"
              echo "============================================"
              echo ""
              echo "✅ PackagesLocalDirectory.zip downloaded from Azure Blob"
              echo "✅ Package extracted"
              echo "✅ Metadata extracted"
              echo "✅ Uploaded to: metadata/standard/"
              echo ""
              echo "Next step: Run quick pipeline to update custom models"
              echo "============================================"
            displayName: 'Log completion summary'